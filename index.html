<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWC #2</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: black;
      font-family: Arial, sans-serif;
      color: white;
      cursor: none;
    }
    iframe {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      border: none;
      z-index: 1;
    }
    #watermark {
      position: fixed;
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 5px black;
      z-index: 9999;
      pointer-events: none;
      user-select: none;
      transition: all 0.5s ease;
    }
    #duplicate-warning {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 999999;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
    }
  </style>
</head>
<body>

<iframe
  id="ytplayer"
  src="https://www.youtube.com/embed/HVthxP19EXs?autoplay=1&mute=1&fs=1&modestbranding=1&controls=0&rel=0"
  allow="autoplay; encrypted-media"
  allowfullscreen
></iframe>

<div id="watermark">N/A</div>
<div id="duplicate-warning">❌ Tento link je už práve používaný.</div>

<script>
  function getParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name)?.toLowerCase();
  }

  const email = getParam('email');
  const watermark = document.getElementById('watermark');
  const iframe = document.getElementById('ytplayer');
  const warning = document.getElementById('duplicate-warning');

  // Načítame JSON súbor s kódmi
  fetch('codes.json')
    .then(response => {
      if (!response.ok) throw new Error("Nepodarilo sa načítať codes.json");
      return response.json();
    })
    .then(codes => {
      const emailKeys = Object.keys(codes);
      const isFreshStart = emailKeys.every(e => localStorage.getItem(`ppv_used_${e}`) === null);

      if (email && codes[email]) {
        const key = `ppv_used_${email}`;
        const alreadyUsed = localStorage.getItem(key);

        if (alreadyUsed && !isFreshStart) {
          // Link už používaný niekým iným
          warning.style.display = 'block';
          iframe.style.display = 'none';
          watermark.textContent = 'Prístup zamietnutý';
        } else {
          // Prvý užívateľ alebo ten istý
          localStorage.setItem(key, 'true');
          watermark.textContent = codes[email];
        }
      } else {
        iframe.style.display = 'none';
        watermark.textContent = "Tvoj kód: Nie je dostupný";
      }
    })
    .catch(e => {
      iframe.style.display = 'none';
      watermark.textContent = "Chyba pri načítaní kódov";
      console.error(e);
    });

  // Watermark pohyb
  const positions = [
    { top: "20px", left: "20px", right: "", transform: "none" },
    { top: "20px", left: "50%", right: "", transform: "translateX(-50%)" },
    { top: "20px", left: "auto", right: "20px", transform: "none" }
  ];

  let currentPosition = 0;

  function changeWatermarkPosition() {
    const pos = positions[currentPosition];
    watermark.style.top = pos.top;
    watermark.style.left = pos.left;
    watermark.style.right = pos.right || "";
    watermark.style.transform = pos.transform;
    currentPosition = (currentPosition + 1) % positions.length;
  }

  changeWatermarkPosition();
  setInterval(changeWatermarkPosition, 15000);

  // Zablokuj pokusy o inspect
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', e => {
    if (
      e.key === 'F12' ||
      e.key.toLowerCase() === 'f' ||
      (e.ctrlKey && (e.key === 'u' || e.key === 'c')) ||
      (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i')
    ) {
      e.preventDefault();
    }
  });
  document.addEventListener('dblclick', e => e.preventDefault());

  // Znovu autoplay pri dotyku na mobile
  document.addEventListener('touchstart', () => {
    const src = iframe.src;
    if (!src.includes("autoplay=1")) {
      iframe.src = src + "&autoplay=1";
    }
  }, { once: true });
</script>

</body>
</html>
